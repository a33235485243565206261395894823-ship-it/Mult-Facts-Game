<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Multiplication Facts</title>
<style>
  :root{
    --bg:#f7f7f7;
    --card:#fff;
    --text:#111;
    --accent:#2b6cb0;
    --danger:#c53030;
  }
  body{
    font-family: system-ui,-apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    margin:0;
    background:var(--bg);
    color:var(--text);
  }

  header{
    background:var(--card);
    padding:12px 20px;
    box-shadow:0 1px 4px rgba(0,0,0,.06);
    display:flex;
    align-items:center;
    justify-content:center;
    position:sticky;
    top:0;
    z-index:10;
  }
  #home-btn {
    position:absolute;
    left:18px;
    top:12px;
    background:#000;
    color:#fff;
    border:none;
    padding:10px 14px;
    border-radius:6px;
    cursor:pointer;
    font-weight:600;
  }
  h1{margin:0; font-size:40px; text-align:center; font-weight:800}

  main{padding:20px; max-width:1200px; margin:0 auto}

  .grid{display:grid; gap:12px}
  .home-grid{
    grid-template-columns: repeat(3, minmax(120px, 1fr));
    align-items:stretch;
    margin-top:18px;
  }
  button.factor{
    cursor:pointer; padding:14px 12px; border-radius:8px; border:1px solid #999; background:var(--card);
    font-size:18px; font-weight:700; color:var(--text);
  }
  button.factor:hover{background:#f0f0f0}
  .custom-btn, .mult-btn, .print-btn{ background:#000; color:#fff; border:1px solid #000; font-weight:700; padding:12px; border-radius:8px; cursor:pointer; }
  .answer-key-home{ background:transparent; color:var(--danger); border:2px solid var(--danger); font-weight:700; padding:12px; border-radius:8px; cursor:pointer; }

  .select-facts { padding:20px; max-width:900px; margin:0 auto; text-align:center; }
  .checkbox-grid{ display:grid; grid-template-columns: repeat(6, 1fr); gap:8px; margin-top:12px; }
  .checkbox-item{ display:flex; align-items:center; justify-content:center; gap:8px; padding:10px; background:var(--card); border-radius:6px; border:1px solid #e6e6e6; font-weight:800; color:var(--text); }
  .select-actions{ display:flex; gap:12px; justify-content:center; margin-top:12px; }

  .select-time { padding:20px; max-width:520px; margin:0 auto; text-align:center; background:var(--card); border-radius:8px; border:1px solid #e6e6e6; color:var(--text); }
  .mode-toggle { display:flex; gap:12px; justify-content:center; margin-bottom:12px; }
  .mode-toggle label{ cursor:pointer; font-weight:700; }

  .top-right-timer{position:fixed; right:18px; top:12px; padding:8px 12px; border-radius:6px; font-weight:700; color:#fff; background:var(--danger); z-index:50}
  .notice{color:var(--danger); font-weight:700; margin-bottom:12px; text-align:center}
  .hidden{display:none}
  #quiz-area{display:flex; gap:16px; flex-direction:column}
  .controls{display:flex; gap:8px; align-items:center; justify-content:center}

  .questions-grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; max-height:65vh; overflow:auto; padding:10px; background:var(--card); border-radius:8px; border:1px solid #e2e8f0; color:var(--text); }
  .question-card{ display:flex; flex-direction:column; gap:8px; padding:12px; border-radius:8px; background:#fafafa; border:1px solid #e6e6e6; min-height:98px; justify-content:center; color:var(--text); }
  .q-label{font-weight:700; font-size:18px; text-align:center}
  input[type="number"], input[type="number"].time-input{ width:100%; padding:8px; border-radius:6px; border:1px solid #bbb; font-size:16px; box-sizing:border-box; color:var(--text); background:transparent; }
  .enter-btn{padding:8px 10px; cursor:pointer}

  .results-grid{ display:grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap:12px; margin-top:12px; }
  .result-card{ padding:10px; border-radius:8px; background:var(--card); border:2px solid #ddd; display:flex; flex-direction:column; gap:8px; color:var(--text); }
  .correct{border-color:#2f855a} .incorrect{border-color:#e53e3e} .small-muted{font-size:13px; color:#555}

  .answer-key{ overflow:auto; background:var(--card); padding:12px; border-radius:6px; border:1px solid #ddd; margin-top:18px; color:var(--text); }

  footer.small-note{ text-align:center; margin-top:12px; font-size:12px; color:gray; }

  .config-note{ color:var(--danger); font-weight:700; text-align:center; margin-bottom:8px; }

  @media (max-width:820px){ .home-grid{grid-template-columns: repeat(2, 1fr)} .questions-grid{grid-template-columns: repeat(2, 1fr)} .checkbox-grid{grid-template-columns: repeat(4, 1fr)} }
  @media (max-width:520px){ h1{font-size:28px} .home-grid{grid-template-columns: 1fr} .questions-grid{grid-template-columns: 1fr} .checkbox-grid{grid-template-columns: repeat(3, 1fr)} #home-btn{top:8px; left:8px; padding:8px 10px} .top-right-timer{right:8px; top:8px; padding:6px 8px} }
</style>
</head>
<body>
<header>
  <button id="home-btn">Home</button>
  <h1>Multiplication Facts</h1>
</header>

<div id="timer" class="top-right-timer hidden">02:00</div>

<main>
  <!-- HOME -->
  <section id="home">
    <p style="text-align:center; margin-top:10px; font-size:18px;">
      Use single-factor buttons, or use <strong>Custom</strong> / <strong>Multiplayer</strong> / <strong>Printable</strong>.
    </p>

    <div class="grid home-grid" id="factor-buttons" style="margin-top:10px"></div>

    <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap; justify-content:center;">
      <button id="btn-custom" class="custom-btn">Custom</button>
      <button id="btn-multiplayer" class="mult-btn">Multiplayer</button>
      <button id="btn-printable" class="print-btn">Printable</button>
      <button id="btn-answerkey" class="answer-key-home">Answer Key</button>
    </div>

    <!-- Rendered answer key chart inserted into home -->
    <div id="home-answer-key" class="answer-key" style="margin-top:18px"></div>
  </section>

  <!-- SELECT FACTS (Custom & Multiplayer & Printable flow) -->
  <section id="select-facts" class="hidden">
    <h2 style="text-align:center">Select Facts</h2>
    <div class="select-facts">
      <div class="checkbox-grid" id="checkbox-grid"></div>
      <div class="select-actions">
        <button id="select-back" class="factor">Back</button>
        <button id="select-finished" class="factor">Finished</button>
      </div>
    </div>
  </section>

  <!-- SELECT TIME (after selecting facts) - used by Custom and Multiplayer -->
  <section id="select-time" class="hidden">
    <h2 style="text-align:center">Select Time / Questions</h2>
    <div class="select-time">
      <div class="mode-toggle">
        <label><input type="radio" name="mode" id="mode-time" value="time" checked> Time</label>
        <label><input type="radio" name="mode" id="mode-questions" value="questions"> Questions</label>
      </div>

      <div id="time-controls">
        <label for="time-minutes">Duration (minutes) — min 0.5, max 10</label>
        <input id="time-minutes" class="time-input" type="number" step="0.5" min="0.5" max="10" value="2" />
      </div>

      <div id="questions-controls" class="hidden">
        <label for="question-count">Number of questions — min 1, max 500</label>
        <input id="question-count" class="time-input" type="number" step="1" min="1" max="500" value="250" />
      </div>

      <div style="display:flex; gap:12px; justify-content:center; margin-top:8px">
        <button id="time-back" class="factor">Back</button>
        <button id="time-start" class="factor">Finished</button>
      </div>
    </div>
  </section>

  <!-- MULTIPLAYER CONFIG -->
  <section id="multiplayer-config" class="hidden">
    <h2 style="text-align:center">Multiplayer (Local Only)</h2>
    <div style="max-width:600px; margin:0 auto; text-align:center; padding:18px; background:var(--card); border-radius:8px; border:1px solid #e6e6e6">
      <div class="config-note">Local Only</div>
      <div style="margin-bottom:12px">
        <label for="num-players" style="font-weight:700">Number of players (2–10): </label>
        <input id="num-players" type="number" min="2" max="10" value="2" style="width:70px; padding:6px; border-radius:6px; border:1px solid #ccc" />
      </div>
      <div style="text-align:left; margin:8px 0">Select Factors:</div>
      <div class="checkbox-grid" id="mult-checkbox-grid" style="margin-bottom:12px"></div>

      <div style="margin-top:8px">
        <div class="mode-toggle">
          <label><input type="radio" name="mult-mode" id="mult-mode-time" value="time" checked> Time</label>
          <label><input type="radio" name="mult-mode" id="mult-mode-questions" value="questions"> Questions</label>
        </div>
        <div id="mult-time-controls">
          <label for="mult-time-minutes">Duration (minutes) — min 0.5, max 10</label><br>
          <input id="mult-time-minutes" class="time-input" type="number" step="0.5" min="0.5" max="10" value="2" style="width:120px; margin-top:6px"/>
        </div>
        <div id="mult-questions-controls" class="hidden">
          <label for="mult-question-count">Number of questions — min 1, max 500</label><br>
          <input id="mult-question-count" class="time-input" type="number" step="1" min="1" max="500" value="50" style="width:120px; margin-top:6px"/>
        </div>
      </div>

      <div style="display:flex; gap:12px; justify-content:center; margin-top:12px">
        <button id="mult-back" class="factor">Back</button>
        <button id="mult-finished" class="factor">Finished</button>
      </div>
    </div>
  </section>

  <!-- MULTIPLAYER START SCREEN -->
  <section id="multiplayer-start" class="hidden">
    <h2 style="text-align:center">Multiplayer Ready</h2>
    <div id="mult-summary" style="max-width:700px; margin:0 auto; text-align:center; padding:16px; background:var(--card); border-radius:8px; border:1px solid #e6e6e6"></div>
    <div style="text-align:center; margin-top:12px">
      <button id="mult-start-btn" class="mult-btn">Start Multiplayer</button>
      <button id="mult-cancel" class="factor" style="margin-left:8px">Cancel</button>
    </div>
  </section>

  <!-- PRINTABLE CONFIG -->
  <section id="printable-config" class="hidden">
    <h2 style="text-align:center">Printable Quiz</h2>
    <div style="max-width:700px; margin:0 auto; text-align:center; padding:18px; background:var(--card); border-radius:8px; border:1px solid #e6e6e6">
      <div style="text-align:left; margin-bottom:8px">Select Factors:</div>
      <div class="checkbox-grid" id="print-checkbox-grid" style="margin-bottom:12px"></div>

      <div style="margin-top:8px; text-align:left;">
        <label for="print-question-count">Number of questions — min 1, max 500</label><br>
        <input id="print-question-count" type="number" min="1" max="500" value="50" style="width:120px; margin-top:6px; padding:6px; border-radius:6px; border:1px solid #ccc"/>
      </div>

      <div style="margin-top:8px; text-align:left;">
        <label><input id="print-include-answerkey" type="checkbox" /> Include Answer Key</label>
      </div>

      <div style="display:flex; gap:12px; justify-content:center; margin-top:12px">
        <button id="print-back" class="factor">Back</button>
        <button id="print-finished" class="factor">Finished</button>
      </div>
    </div>
  </section>

  <!-- QUIZ -->
  <section id="quiz" class="hidden">
    <div id="quiz-area">
      <div id="notice" class="notice">You have a time limit — try to complete as many questions as possible</div>

      <div class="controls">
        <button id="start-btn" class="factor">Start</button>
        <button id="finish-now">Finish Now</button>
        <div style="min-width:220px; text-align:center"><strong>Selected:</strong> <span id="selected-factor"></span></div>
      </div>

      <div class="questions-grid hidden" id="questions-grid" aria-live="polite"></div>
    </div>
  </section>

  <!-- MULTIPLAYER PLAY (one question at a time) -->
  <section id="mult-play" class="hidden">
    <h2 id="mult-play-title" style="text-align:center">Multiplayer Quiz</h2>
    <div id="mult-play-area" style="max-width:700px; margin:0 auto; padding:16px; background:var(--card); border:1px solid #e6e6e6; border-radius:8px; text-align:center">
      <div id="mult-timer" class="top-right-timer hidden" style="position:static; display:inline-block; margin-bottom:12px"></div>
      <div id="mult-turn" style="font-size:18px; font-weight:800; margin-bottom:12px"></div>
      <div id="mult-question" style="font-size:20px; font-weight:700; margin-bottom:12px"></div>
      <input id="mult-answer" type="number" style="padding:8px; width:160px; border-radius:6px; border:1px solid #ccc; font-size:16px"/>
      <div style="margin-top:12px">
        <button id="mult-next" class="factor">Enter</button>
      </div>
      <div style="margin-top:8px; font-size:13px; color:gray">If time runs out, current round completes so each player answers the same number of questions.</div>
    </div>
  </section>

  <!-- RESULTS -->
  <section id="results" class="hidden">
    <h2 style="text-align:center">Results</h2>
    <div id="summary" style="margin:12px auto; max-width:900px; text-align:center"></div>

    <div style="display:flex; gap:8px; justify-content:center; margin-top:8px">
      <button id="hide-questions-btn" class="factor">Hide Questions</button>
    </div>

    <div id="results-grid" class="results-grid"></div>

    <div style="margin-top:12px; text-align:center">
      <button id="back-home" class="factor">Back to Home</button>
    </div>

    <div style="text-align:center; margin-top:8px; font-size:12px; color:gray;">
      Use browser print function (Ctrl+P or Cmd+P) to print results.
    </div>
  </section>

  <!-- ANSWER KEY (separate full view - password protected) -->
  <section id="answer-key" class="hidden">
    <h2 style="text-align:center">Answer Key (1 × 1 through 12 × 12)</h2>
    <div class="answer-key" id="answer-key-table" style="max-width:900px; margin:12px auto"></div>
    <div style="margin-top:12px; text-align:center">
      <button id="close-answerkey">Close Answer Key</button>
    </div>
  </section>
</main>

<script>
/* ---------- Config ---------- */
const PASSWORD = "BOfat123";
const POOL_250 = 250;

/* ---------- Helpers ---------- */
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }

/* ---------- State ---------- */
let selectedFactorsSet = new Set();
let questions = []; // pool for current quiz
let timerInterval = null;
let secondsLeft = 0;
let startTime = null;
let finished = false;

/* Multiplayer specific state */
let multPlayers = 2;
let multMode = "time"; // or "questions"
let multDurationMinutes = 2;
let multQuestionCount = 50;
let multPool = [];
let multCurrentIndex = 0;
let multCurrentPlayer = 0;
let multAnswers = []; // array of arrays per player: {a,b,answer,userAnswer,timeAnswered}
let multPlayersThisRound = 0;
let multTimeExpired = false;

/* DOM refs */
const factorButtonsEl = document.getElementById("factor-buttons");
const homeSection = document.getElementById("home");
const selectFactsSection = document.getElementById("select-facts");
const selectTimeSection = document.getElementById("select-time");
const quizSection = document.getElementById("quiz");
const multConfigSection = document.getElementById("multiplayer-config");
const multStartSection = document.getElementById("multiplayer-start");
const multPlaySection = document.getElementById("mult-play");
const printableConfig = document.getElementById("printable-config");
const resultsSection = document.getElementById("results");
const answerKeySection = document.getElementById("answer-key");

const homeAnswerKeyDiv = document.getElementById("home-answer-key");
const checkboxGrid = document.getElementById("checkbox-grid");
const multCheckboxGrid = document.getElementById("mult-checkbox-grid");
const printCheckboxGrid = document.getElementById("print-checkbox-grid");

const selectBackBtn = document.getElementById("select-back");
const selectFinishedBtn = document.getElementById("select-finished");
const modeTimeRadio = document.getElementById("mode-time");
const modeQuestionsRadio = document.getElementById("mode-questions");
const timeControls = document.getElementById("time-controls");
const questionsControls = document.getElementById("questions-controls");
const timeMinutesInput = document.getElementById("time-minutes");
const questionCountInput = document.getElementById("question-count");
const timeBackBtn = document.getElementById("time-back");
const timeStartBtn = document.getElementById("time-start");

const multNumPlayers = document.getElementById("num-players");
const multModeTime = document.getElementById("mult-mode-time");
const multModeQuestions = document.getElementById("mult-mode-questions");
const multTimeControls = document.getElementById("mult-time-controls");
const multQuestionsControls = document.getElementById("mult-questions-controls");
const multTimeInput = document.getElementById("mult-time-minutes");
const multQuestionCountInput = document.getElementById("mult-question-count");
const multBackBtn = document.getElementById("mult-back");
const multFinishedBtn = document.getElementById("mult-finished");

const multSummary = document.getElementById("mult-summary");
const multStartBtn = document.getElementById("mult-start-btn");
const multCancel = document.getElementById("mult-cancel");
const multTurnEl = document.getElementById("mult-turn");
const multQuestionEl = document.getElementById("mult-question");
const multAnswerInput = document.getElementById("mult-answer");
const multNextBtn = document.getElementById("mult-next");
const multTimerEl = document.getElementById("mult-timer");

const printCountInput = document.getElementById("print-question-count");
const printIncludeKey = document.getElementById("print-include-answerkey");
const printBackBtn = document.getElementById("print-back");
const printFinishedBtn = document.getElementById("print-finished");

const questionsGrid = document.getElementById("questions-grid");
const startBtn = document.getElementById("start-btn");
const finishNowBtn = document.getElementById("finish-now");
const selectedFactorSpan = document.getElementById("selected-factor");

const resultsGrid = document.getElementById("results-grid");
const summaryEl = document.getElementById("summary");
const hideQuestionsBtn = document.getElementById("hide-questions-btn");

/* ---------- Initialize home factor buttons and other buttons ---------- */
for(let i=1;i<=12;i++){
  const btn = document.createElement("button");
  btn.className = "factor";
  btn.textContent = `${i} facts`;
  btn.addEventListener("click", ()=> { prepareSingle(i); });
  factorButtonsEl.appendChild(btn);
}

/* Home action buttons */
document.getElementById("btn-custom").addEventListener("click", ()=> showSelectFactsFlow("custom"));
document.getElementById("btn-multiplayer").addEventListener("click", ()=> showMultiplayerConfig());
document.getElementById("btn-printable").addEventListener("click", ()=> showPrintableConfig());
document.getElementById("btn-answerkey").addEventListener("click", showAnswerKeyPrompt);

renderHomeAnswerKey();

/* ---------- Render home answer key chart ---------- */
function renderHomeAnswerKey(){
  let html = '<table style="border-collapse:collapse; margin:0 auto">';
  html += '<thead><tr><th style="padding:6px 8px; border:1px solid #ddd; background:#fafafa; font-weight:800">×</th>';
  for(let c=1;c<=12;c++) html += `<th style="padding:6px 8px; border:1px solid #ddd; background:#fafafa; font-weight:800">${c}</th>`;
  html += '</tr></thead><tbody>';
  for(let r=1;r<=12;r++){
    html += `<tr><th style="padding:6px 8px; border:1px solid #ddd; background:#fafafa; font-weight:800">${r}</th>`;
    for(let c=1;c<=12;c++){
      html += `<td style="padding:6px 8px; border:1px solid #eee">${r*c}</td>`;
    }
    html += '</tr>';
  }
  html += '</tbody></table>';
  homeAnswerKeyDiv.innerHTML = html;
}

/* ---------- Answer Key prompt / full view ---------- */
function showAnswerKeyPrompt(){
  const pass = prompt("Enter password to view the Answer Key:");
  if(pass === null) return;
  if(pass === PASSWORD){
    renderAnswerKeyFull();
    showSection('answer-key');
  } else alert("Incorrect password.");
}
function renderAnswerKeyFull(){
  const el = document.getElementById("answer-key-table");
  let html = '<table style="border-collapse:collapse; margin:0 auto">';
  html += '<thead><tr><th style="padding:6px 8px; border:1px solid #ddd; background:#fafafa; font-weight:800">×</th>';
  for(let c=1;c<=12;c++) html += `<th style="padding:6px 8px; border:1px solid #ddd; background:#fafafa; font-weight:800">${c}</th>`;
  html += '</tr></thead><tbody>';
  for(let r=1;r<=12;r++){
    html += `<tr><th style="padding:6px 8px; border:1px solid #ddd; background:#fafafa; font-weight:800">${r}</th>`;
    for(let c=1;c<=12;c++){
      html += `<td style="padding:6px 8px; border:1px solid #eee">${r*c}</td>`;
    }
    html += '</tr>';
  }
  html += '</tbody></table>';
  el.innerHTML = html;
}

/* ---------- Simple section navigation ---------- */
function showSection(id){
  const sections = ['home','select-facts','select-time','multiplayer-config','multiplayer-start','mult-play','printable-config','quiz','results','answer-key'];
  sections.forEach(s=>{ const el=document.getElementById(s); if(el) el.classList.add('hidden');});
  const target = document.getElementById(id);
  if(target) target.classList.remove('hidden');
  window.scrollTo(0,0);
}

/* ---------- SELECT FACTS flow used by custom / multiplayer / printable ---------- */
let invokingFlow = null; // 'custom' | 'multiplayer' | 'printable'
function showSelectFactsFlow(flow){
  invokingFlow = flow;
  // Populate checkboxes (reuse)
  checkboxGrid.innerHTML = '';
  for(let i=1;i<=12;i++){
    const label = document.createElement('label');
    label.className='checkbox-item';
    const chk = document.createElement('input');
    chk.type='checkbox'; chk.value=i; chk.checked = selectedFactorsSet.has(i);
    chk.addEventListener('change', (ev)=>{ if(ev.target.checked) selectedFactorsSet.add(i); else selectedFactorsSet.delete(i); });
    const span = document.createElement('span'); span.textContent = i; span.style.fontWeight='800';
    label.appendChild(chk); label.appendChild(span);
    checkboxGrid.appendChild(label);
  }
  showSection('select-facts');
}

/* SELECT FACTS buttons */
selectBackBtn.addEventListener('click', ()=>{ showSection('home'); });
selectFinishedBtn.addEventListener('click', ()=>{
  if(selectedFactorsSet.size === 0){ alert('Select at least one factor (1–12) to continue.'); return; }
  if(invokingFlow === 'custom'){
    // go to select-time to choose time/questions
    showSection('select-time');
  } else if(invokingFlow === 'multiplayer'){
    // prepopulate multiplayer checkboxes and go to multiplayer-config
    populateMultCheckboxes();
    showSection('multiplayer-config');
  } else if(invokingFlow === 'printable'){
    populatePrintCheckboxes();
    showSection('printable-config');
  } else {
    showSection('home');
  }
});

/* ---------- SELECT TIME controls (for Custom flow) ---------- */
modeTimeRadio.addEventListener('change', ()=>{ timeControls.classList.remove('hidden'); questionsControls.classList.add('hidden'); });
modeQuestionsRadio.addEventListener('change', ()=>{ timeControls.classList.add('hidden'); questionsControls.classList.remove('hidden'); });
timeBackBtn.addEventListener('click', ()=> showSection('select-facts'));
timeStartBtn.addEventListener('click', ()=>{
  if(modeTimeRadio.checked){
    const v = Number(timeMinutesInput.value);
    if(isNaN(v) || v < 0.5 || v > 10){ alert('Enter a valid duration between 0.5 and 10 minutes.'); return; }
    // Prepare custom time quiz
    prepareCustom(Array.from(selectedFactorsSet), { mode:'time', durationMinutes: v });
  } else {
    const qc = Number(questionCountInput.value);
    if(isNaN(qc) || qc < 1 || qc > 500){ alert('Enter a valid question count between 1 and 500.'); return; }
    prepareCustom(Array.from(selectedFactorsSet), { mode:'questions', questionCount: qc });
  }
});

/* ---------- Custom prepare (reusable) ---------- */
function prepareCustom(selectedFactorsArray, opts){
  // Build a base shuffled pool of 250 (random factors among selectedFactorsArray)
  const base = [];
  while(base.length < POOL_250){
    const a = selectedFactorsArray[Math.floor(Math.random()*selectedFactorsArray.length)];
    const b = Math.floor(Math.random()*12)+1;
    base.push({a,b,answer:a*b});
  }
  shuffle(base);

  if(opts.mode === 'time'){
    questions = base.map(q=>({...q, userAnswer:'', timeAnswered:null}));
    // record selected duration on a globalish variable (for Start press)
    window._currentQuiz = { mode:'time', durationMinutes: opts.durationMinutes || 2, questionsCount: questions.length };
  } else {
    const qc = opts.questionCount;
    if(qc <= POOL_250){
      questions = base.slice(0,qc).map(q=>({...q, userAnswer:'', timeAnswered:null}));
    } else {
      // qc > 250: repeat first (qc-250) of base without reshuffle
      const extra = base.slice(0, qc-POOL_250).map(q=>({...q}));
      questions = base.map(q=>({...q, userAnswer:'', timeAnswered:null})).concat(extra);
    }
    window._currentQuiz = { mode:'questions', questionCount: qc, questionsCount: questions.length };
  }
  // show quiz page (but do not start)
  selectedFactorSpan.textContent = selectedFactorsArray.join(', ');
  showSection('quiz');
  questionsGrid.innerHTML='';
  questionsGrid.classList.add('hidden');
  startBtn.disabled=false;
}

/* ---------- Start / Timer / Quiz behavior for custom single-user quizzes ---------- */
startBtn.addEventListener('click', ()=>{
  if(!questions || questions.length===0){ alert('No quiz prepared.'); return; }
  startBtn.disabled = true;
  const info = window._currentQuiz || {};
  if(info.mode === 'time'){
    const durationSec = Math.round((info.durationMinutes||2)*60);
    secondsLeft = durationSec;
    document.getElementById('timer').classList.remove('hidden');
    updateTimerDisplay();
    startTime = Date.now();
    renderQuestionsGrid();
    timerInterval = setInterval(()=>{
      secondsLeft = Math.max(0, durationSec - Math.floor((Date.now()-startTime)/1000));
      updateTimerDisplay();
      if(secondsLeft <= 0){ clearInterval(timerInterval); timerInterval=null; document.getElementById('timer').classList.add('hidden'); finishQuiz(); }
    },200);
  } else {
    // questions mode: no timer
    document.getElementById('timer').classList.add('hidden');
    renderQuestionsGrid();
  }
});

function renderQuestionsGrid(){
  questionsGrid.innerHTML='';
  for(let i=0;i<questions.length;i++){
    const q = questions[i];
    const card = document.createElement('div'); card.className='question-card';
    const lbl = document.createElement('div'); lbl.className='q-label'; lbl.textContent = `${q.a} × ${q.b} =`; card.appendChild(lbl);
    const input = document.createElement('input'); input.type='number'; input.dataset.index=i;
    input.value = q.userAnswer || '';
    input.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter'){ recordAnswerGrid(i); }});
    input.addEventListener('input', (ev)=> { questions[i].userAnswer = ev.target.value; });
    const enter = document.createElement('button'); enter.className='enter-btn'; enter.textContent='Enter'; enter.addEventListener('click', ()=> recordAnswerGrid(i));
    card.appendChild(input); card.appendChild(enter);
    questionsGrid.appendChild(card);
  }
  questionsGrid.classList.remove('hidden');
  const f = questionsGrid.querySelector('input[data-index="0"]'); if(f) f.focus();
}
function recordAnswerGrid(i){
  const next = i+1;
  const el = questionsGrid.querySelector(`input[data-index="${next}"]`);
  if(el) el.focus();
}

/* ---------- Finish / Results for single-user quizzes ---------- */
finishNowBtn.addEventListener('click', ()=>{ if(confirm('Finish now?')) finishQuiz(); });

function finishQuiz(){
  if(finished) return;
  finished = true;
  if(timerInterval){ clearInterval(timerInterval); timerInterval=null; document.getElementById('timer').classList.add('hidden'); }
  const now = Date.now();
  const elapsed = Math.round((now - (startTime||now))/1000);
  const completed = questions.filter(q=> q.userAnswer !== '' && q.userAnswer !== undefined);
  let correctCount = 0;
  resultsGrid.innerHTML='';
  for(let i=0;i<questions.length;i++){
    const q = questions[i];
    if(q.userAnswer !== '' && q.userAnswer !== undefined){
      const ua = Number(q.userAnswer);
      const correct = ua === q.answer;
      if(correct) correctCount++;
      const card = document.createElement('div'); card.className = 'result-card ' + (correct ? 'correct' : 'incorrect');
      const top = document.createElement('div'); top.textContent = `${q.a} × ${q.b} =`; top.style.fontWeight='700';
      const box = document.createElement('div'); box.style.padding='8px'; box.style.background='#f3f3f3'; box.textContent = q.userAnswer;
      const ca = document.createElement('div'); ca.className='small-muted'; ca.textContent = `Correct Answer: ${q.answer}`;
      card.appendChild(top); card.appendChild(box); card.appendChild(ca);
      resultsGrid.appendChild(card);
    }
  }
  const avg = completed.length>0 ? (elapsed / completed.length) : 0;
  const qpm = avg>0 ? (60/avg) : 0;
  summaryEl.innerHTML = `<div><strong>Score:</strong> ${correctCount} / ${completed.length}</div>
    <div><strong>Percentage:</strong> ${completed.length>0 ? ((correctCount/completed.length)*100).toFixed(1)+'%' : '0%'}</div>
    <div><strong>Total elapsed:</strong> ${elapsed} seconds</div>
    <div><strong>Average time per answered question:</strong> ${avg.toFixed(2)} s</div>
    <div><strong>Questions per minute (from average):</strong> ${qpm.toFixed(2)}</div>`;
  showSection('results');
}

/* Hide questions toggle */
let questionsHidden = false;
hideQuestionsBtn.addEventListener('click', ()=>{
  questionsHidden = !questionsHidden;
  resultsGrid.style.display = questionsHidden ? 'none' : 'grid';
  hideQuestionsBtn.textContent = questionsHidden ? 'Show Questions' : 'Hide Questions';
});

/* Back home */
document.getElementById('back-home').addEventListener('click', ()=>{ showSection('home'); });

/* ---------- MULTIPLAYER FLOW ---------- */
function showMultiplayerConfig(){
  // populate mult-checkbox
  populateMultCheckboxes();
  showSection('multiplayer-config');
}
function populateMultCheckboxes(){
  multCheckboxGrid.innerHTML='';
  for(let i=1;i<=12;i++){
    const label = document.createElement('label');
    label.className='checkbox-item';
    const chk = document.createElement('input'); chk.type='checkbox'; chk.value=i; chk.checked = selectedFactorsSet.has(i);
    chk.addEventListener('change', (ev)=>{ if(ev.target.checked) selectedFactorsSet.add(i); else selectedFactorsSet.delete(i); });
    const span = document.createElement('span'); span.textContent = i; span.style.fontWeight='800';
    label.appendChild(chk); label.appendChild(span);
    multCheckboxGrid.appendChild(label);
  }
}
multBackBtn.addEventListener('click', ()=> showSection('home'));
multFinishedBtn.addEventListener('click', ()=>{
  // validate
  if(selectedFactorsSet.size === 0){ alert('Select at least one factor for multiplayer.'); return; }
  const np = Number(multNumPlayers.value);
  if(isNaN(np) || np < 2 || np > 10){ alert('Players must be 2–10.'); return; }
  multPlayers = np;
  // mode
  if(multModeTime.checked){ multMode='time'; multDurationMinutes = Number(multTimeInput.value); if(isNaN(multDurationMinutes) || multDurationMinutes<0.5 || multDurationMinutes>10){ alert('Enter a valid duration 0.5–10 minutes'); return; } }
  else { multMode='questions'; multQuestionCount = Number(multQuestionCountInput.value); if(isNaN(multQuestionCount)||multQuestionCount<1||multQuestionCount>500){ alert('Enter valid question count 1–500'); return; } }
  // prepare pool
  prepareMultPool(Array.from(selectedFactorsSet), {mode:multMode, durationMinutes:multDurationMinutes, questionCount:multQuestionCount});
  // show summary and start page
  const factors = Array.from(selectedFactorsSet).join(', ');
  let summary = `<div><strong>Players:</strong> ${multPlayers}</div><div><strong>Factors:</strong> ${factors}</div>`;
  if(multMode==='time') summary += `<div><strong>Mode:</strong> Time — ${multDurationMinutes} minutes</div>`;
  else summary += `<div><strong>Mode:</strong> Questions — ${multQuestionCount} total</div>`;
  multSummary.innerHTML = summary;
  showSection('multiplayer-start');
});

/* Mode radios in mult config */
multModeTime.addEventListener('change', ()=>{ multTimeControls.classList.remove('hidden'); multQuestionsControls.classList.add('hidden'); });
multModeQuestions.addEventListener('change', ()=>{ multTimeControls.classList.add('hidden'); multQuestionsControls.classList.remove('hidden'); });

multCancel.addEventListener('click', ()=> showSection('home'));

/* Prepare multiplayer pool */
function prepareMultPool(factorsArray, opts){
  // build base 250 pool
  const base = [];
  while(base.length < POOL_250){
    const a = factorsArray[Math.floor(Math.random()*factorsArray.length)];
    const b = Math.floor(Math.random()*12)+1;
    base.push({a,b,answer:a*b});
  }
  shuffle(base);
  if(opts.mode === 'time'){
    // use base 250 as pool; rounds will consume sequentially and wrap if needed
    multPool = base.map(q=>({...q}));
  } else {
    let qc = opts.questionCount;
    if(qc <= POOL_250) multPool = base.slice(0,qc).map(q=>({...q}));
    else {
      const extra = base.slice(0, qc - POOL_250).map(q=>({...q}));
      multPool = base.map(q=>({...q})).concat(extra);
    }
  }
  // initialize per-player answer arrays
  multAnswers = [];
  for(let p=0;p<multPlayers;p++) multAnswers.push([]);
  multCurrentIndex = 0;
  multCurrentPlayer = 0;
  multPlayersThisRound = 0;
  multTimeExpired = false;
}

/* Start multiplayer from start screen */
multStartBtn.addEventListener('click', ()=>{
  showSection('mult-play');
  // set title
  document.getElementById('mult-play-title').textContent = 'Multiplayer Quiz';
  // prepare timer if time mode
  if(multMode === 'time'){
    const durationSec = Math.round(multDurationMinutes * 60);
    secondsLeft = durationSec;
    multTimerEl.classList.remove('hidden');
    multTimerEl.textContent = formatTime(secondsLeft);
    startTime = Date.now();
    timerInterval = setInterval(()=>{
      secondsLeft = Math.max(0, durationSec - Math.floor((Date.now()-startTime)/1000));
      multTimerEl.textContent = formatTime(secondsLeft);
      if(secondsLeft <= 0){
        // time expired — set flag and stop timer; allow current round to finish
        clearInterval(timerInterval); timerInterval=null;
        multTimeExpired = true;
        multTimerEl.textContent = '00:00';
        // do not auto-finish here; finish condition handled after each player's turn
      }
    }, 200);
  } else {
    multTimerEl.classList.add('hidden');
  }
  // show first question to player 1
  showNextMultQuestion();
});

/* Show next multiplayer question for current player */
function showNextMultQuestion(){
  if(multCurrentIndex >= multPool.length){
    // no more questions -> finish now
    finishMultiplayer();
    return;
  }
  const q = multPool[multCurrentIndex];
  multTurnEl.textContent = `Player ${multCurrentPlayer + 1}'s turn`;
  multQuestionEl.textContent = `${q.a} × ${q.b} =`;
  multAnswerInput.value = '';
  multAnswerInput.focus();
}

/* Enter answer / next for multiplayer */
multNextBtn.addEventListener('click', ()=> handleMultEnter());
multAnswerInput.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter') handleMultEnter(); });

function handleMultEnter(){
  const raw = multAnswerInput.value;
  // record into multAnswers for current player
  const q = multPool[multCurrentIndex];
  const record = { a:q.a, b:q.b, answer:q.answer, userAnswer: raw === '' ? '' : raw, timeAnswered: multTimeExpired ? null : ( (startTime ? Math.round((Date.now()-startTime)/1000) : null) ) };
  multAnswers[multCurrentPlayer].push(record);

  // advance player and index
  multCurrentPlayer++;
  multPlayersThisRound++;
  if(multCurrentPlayer >= multPlayers){
    // completed a full round
    multCurrentPlayer = 0;
    // after full round, check if time expired; if so finish
    if(multTimeExpired){
      finishMultiplayer();
      return;
    }
  }
  multCurrentIndex++;
  // If questions mode and we've reached questionCount, finish when pool consumed
  if(multMode === 'questions' && multCurrentIndex >= multPool.length){
    // But ensure if we finished mid-round we still let remaining players answer? Spec says rotate until questions run out; that's fine.
    finishMultiplayer();
    return;
  }
  // Otherwise show next question
  showNextMultQuestion();
}

/* Finish multiplayer and show results per player */
function finishMultiplayer(){
  // stop timer if running
  if(timerInterval){ clearInterval(timerInterval); timerInterval=null; }
  // Build results view
  resultsGrid.innerHTML = '';
  let totalCompleted = 0;
  let totalCorrect = 0;
  for(let p=0;p<multPlayers;p++){
    const answers = multAnswers[p];
    let correct = 0;
    answers.forEach(a=>{ if(a.userAnswer !== '' && Number(a.userAnswer) === a.answer) correct++; });
    totalCompleted += answers.length;
    totalCorrect += correct;
    const card = document.createElement('div'); card.className='result-card';
    const title = document.createElement('div'); title.innerHTML = `<strong>Player ${p+1}</strong> — ${correct}/${answers.length} correct`;
    card.appendChild(title);
    // list answers
    answers.forEach(a=>{
      const row = document.createElement('div'); row.style.display='flex'; row.style.flexDirection='column';
      const q = document.createElement('div'); q.textContent = `${a.a} × ${a.b} = ${a.userAnswer === '' ? '(no answer)' : a.userAnswer}`;
      const correctLine = document.createElement('div'); correctLine.className='small-muted'; correctLine.textContent = `Correct Answer: ${a.answer}`;
      if(a.userAnswer !== '' && Number(a.userAnswer) === a.answer) row.style.borderLeft = '4px solid #2f855a'; else row.style.borderLeft='4px solid #e53e3e';
      row.style.padding='6px'; row.style.marginTop='6px'; row.appendChild(q); row.appendChild(correctLine);
      card.appendChild(row);
    });
    resultsGrid.appendChild(card);
  }
  summaryEl.innerHTML = `<div><strong>Total answers collected:</strong> ${totalCompleted}</div>`;
  showSection('results');
}

/* ---------- PRINTABLE flow: prepare and open new window with questions and optional answer key ---------- */
function showPrintableConfig(){
  // populate print-checkbox
  printCheckboxGrid.innerHTML='';
  for(let i=1;i<=12;i++){
    const label = document.createElement('label');
    label.className='checkbox-item';
    const chk = document.createElement('input'); chk.type='checkbox'; chk.value=i; chk.checked = selectedFactorsSet.has(i);
    chk.addEventListener('change', (ev)=>{ if(ev.target.checked) selectedFactorsSet.add(i); else selectedFactorsSet.delete(i); });
    const span = document.createElement('span'); span.textContent = i; span.style.fontWeight='800';
    label.appendChild(chk); label.appendChild(span);
    printCheckboxGrid.appendChild(label);
  }
  showSection('printable-config');
}
printBackBtn.addEventListener('click', ()=> showSection('home'));
printFinishedBtn.addEventListener('click', ()=>{
  const chosen = Array.from(selectedFactorsSet);
  if(chosen.length===0){ alert('Select at least one factor for printable.'); return; }
  const qc = Number(printCountInput.value);
  if(isNaN(qc) || qc<1 || qc>500){ alert('Enter 1–500 questions.'); return; }
  // prepare a pool same logic: base 250 then slice/repeat per rules
  const base = [];
  while(base.length < POOL_250){
    const a = chosen[Math.floor(Math.random()*chosen.length)];
    const b = Math.floor(Math.random()*12)+1;
    base.push({a,b,answer:a*b});
  }
  shuffle(base);
  let final = [];
  if(qc <= POOL_250) final = base.slice(0,qc);
  else {
    const extra = base.slice(0, qc-POOL_250);
    final = base.concat(extra);
  }
  // open printable window and write content
  const win = window.open('', '_blank');
  const header = `<h1 style="text-align:center; font-size:28px; margin:8px 0">Multiplication Facts</h1>
    <div style="text-align:center; margin-bottom:12px">Factor(s): ${chosen.join(', ')} | ${qc} Questions</div>`;
  let bodyHtml = `<html><head><title>Printable Quiz</title><style>body{font-family:Arial,Helvetica,sans-serif; padding:20px;} .row{display:flex; gap:12px; flex-wrap:nowrap;}</style></head><body>`;
  bodyHtml += header;
  // generate numbered list 5 per row
  bodyHtml += '<div style="font-size:18px;">';
  for(let i=0;i<final.length;i++){
    if(i % 5 === 0) bodyHtml += '<div class="row" style="margin-bottom:12px">';
    const num = i+1;
    bodyHtml += `<div style="width:18%;"><strong>${num}.</strong> ${final[i].a}×${final[i].b} = ________</div>`;
    if(i % 5 === 4) bodyHtml += '</div>';
  }
  if(final.length % 5 !== 0) bodyHtml += '</div>'; // close last row
  // footer note
  bodyHtml += `<div style="margin-top:20px; font-size:12px; color:gray; text-align:center">Use browser print function (Ctrl+P or Cmd+P) to print this page.</div>`;
  // if include answer key, add page break and answer key
  if(printIncludeKey.checked){
    bodyHtml += '<div style="page-break-before:always; margin-top:30px">';
    bodyHtml += '<h2 style="text-align:center">Answer Key</h2>';
    bodyHtml += '<div style="display:block; text-align:left; font-size:16px; margin-top:12px">';
    for(let i=0;i<final.length;i++){
      const num = i+1;
      bodyHtml += `<div style="margin-bottom:6px"><strong>${num}.</strong> ${final[i].a}×${final[i].b} = ${final[i].answer}</div>`;
    }
    bodyHtml += '</div></div>';
  }
  bodyHtml += '</body></html>';
  win.document.open();
  win.document.write(bodyHtml);
  win.document.close();
  // return to home
  showSection('home');
});

/* ---------- Utility: formatTime ---------- */
function formatTime(sec){
  const mm = String(Math.floor(sec/60)).padStart(2,'0');
  const ss = String(sec%60).padStart(2,'0');
  return `${mm}:${ss}`;
}

/* ---------- Initial state ---------- */
showSection('home');
</script>
</body>
</html>
