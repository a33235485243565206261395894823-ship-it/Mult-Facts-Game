<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Multiplication Facts</title>
<style>
  :root{
    --bg:#f7f7f7;
    --card:#fff;
    --accent:#2b6cb0;
    --danger:#c53030;
  }
  body{
    font-family: system-ui,-apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    margin:0;
    background:var(--bg);
    color:#111;
  }

  /* Header: Home button (left) + centered enlarged title */
  header{
    background:#fff;
    padding:12px 20px;
    box-shadow:0 1px 4px rgba(0,0,0,.06);
    display:flex;
    align-items:center;
    justify-content:center;
    position:sticky;
    top:0;
    z-index:10;
  }
  #home-btn {
    position:absolute;
    left:18px;
    top:12px;
    background:#000;
    color:#fff;
    border:none;
    padding:10px 14px;
    border-radius:6px;
    cursor:pointer;
    font-weight:600;
  }
  h1{
    margin:0;
    font-size:40px;
    text-align:center;
    font-weight:800;
  }

  main{padding:20px; max-width:1200px; margin:0 auto}

  /* Factor buttons */
  .grid{display:grid; gap:12px}
  .home-grid{
    grid-template-columns: repeat(3, minmax(120px, 1fr)); /* 3 per row */
    align-items:stretch;
    margin-top:18px;
  }
  button.factor{
    cursor:pointer;
    padding:14px 12px;
    border-radius:8px;
    border:1px solid #999;
    background:#fff;
    font-size:18px;
    font-weight:700;
  }
  button.factor:hover{background:#f0f0f0}
  button.factor.selected{
    background:var(--accent);
    color:#fff;
    border-color:transparent;
  }

  /* Custom button (black) */
  button.custom-btn{
    background:#000;
    color:#fff;
    border:1px solid #000;
    font-weight:700;
    padding:12px;
    border-radius:8px;
  }

  /* Answer Key button (red outline, red text) */
  button.answer-key-home{
    background:transparent;
    color:var(--danger);
    border:2px solid var(--danger);
    font-weight:700;
    padding:12px;
    border-radius:8px;
  }

  /* Select-Facts & Select-Time */
  .select-facts { padding:20px; max-width:900px; margin:0 auto; text-align:center; }
  .checkbox-grid{ display:grid; grid-template-columns: repeat(6, 1fr); gap:8px; margin-top:12px; }
  .checkbox-item{ display:flex; align-items:center; justify-content:center; gap:8px; padding:10px; background:#fff; border-radius:6px; border:1px solid #e6e6e6; font-weight:800; }
  .select-actions{ display:flex; gap:12px; justify-content:center; margin-top:12px; }

  .select-time { padding:20px; max-width:420px; margin:0 auto; text-align:center; background:var(--card); border-radius:8px; border:1px solid #e6e6e6; }

  /* Quiz area */
  .top-right-timer{position:fixed; right:18px; top:12px; padding:8px 12px; border-radius:6px; font-weight:700; color:#fff; background:var(--danger); z-index:50}
  .notice{color:var(--danger); font-weight:700; margin-bottom:12px; text-align:center}
  .hidden{display:none}
  #quiz-area{display:flex; gap:16px; flex-direction:column}
  .controls{display:flex; gap:8px; align-items:center; justify-content:center}

  /* Questions grid: 3 per row */
  .questions-grid{
    display:grid;
    grid-template-columns: repeat(3, 1fr);
    gap:12px;
    max-height:65vh;
    overflow:auto;
    padding:10px;
    background:var(--card);
    border-radius:8px;
    border:1px solid #e2e8f0;
  }
  .question-card{
    display:flex;
    flex-direction:column;
    gap:8px;
    padding:12px;
    border-radius:8px;
    background:#fafafa;
    border:1px solid #e6e6e6;
    min-height:98px;
    justify-content:center;
  }
  .q-label{font-weight:700; font-size:18px; text-align:center}
  input[type="number"], input[type="number"].time-input{
    width:100%;
    padding:8px;
    border-radius:6px;
    border:1px solid #bbb;
    font-size:16px;
    box-sizing:border-box;
  }
  .enter-btn{padding:8px 10px; cursor:pointer}

  /* Results */
  .results-grid{
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap:12px;
  }
  .result-card{
    padding:10px;
    border-radius:8px;
    background:var(--card);
    border:2px solid #ddd;
    display:flex;
    flex-direction:column;
    gap:8px;
  }
  .correct{border-color:#2f855a}
  .incorrect{border-color:#e53e3e}
  .small-muted{font-size:13px; color:#555}

  /* Answer key table */
  .answer-key{overflow:auto; background:var(--card); padding:12px; border-radius:6px; border:1px solid #ddd; margin-top:18px}

  /* home answer key area */
  #home-answer-key { margin-top:18px; }

  /* Responsive */
  @media (max-width:820px){
    .home-grid{grid-template-columns: repeat(2, 1fr)}
    .questions-grid{grid-template-columns: repeat(2, 1fr)}
    .checkbox-grid{grid-template-columns: repeat(4, 1fr)}
  }
  @media (max-width:520px){
    h1{font-size:28px}
    .home-grid{grid-template-columns: 1fr}
    .questions-grid{grid-template-columns: 1fr}
    .checkbox-grid{grid-template-columns: repeat(3, 1fr)}
    #home-btn{top:8px; left:8px; padding:8px 10px}
    .top-right-timer{right:8px; top:8px; padding:6px 8px}
  }
</style>
</head>
<body>
<header>
  <button id="home-btn">Home</button>
  <h1>Multiplication Facts</h1>
</header>

<div id="timer" class="top-right-timer hidden">02:00</div>

<main>
  <!-- HOME -->
  <section id="home">
    <p style="text-align:center; margin-top:10px; font-size:18px;">
      Use the factor buttons for single-factor practice, or use <strong>Custom</strong> to build mixed quizzes - Use Ctrl+P to Print Results & Printed Questions
    </p>

    <div class="grid home-grid" id="factor-buttons" style="margin-top:10px"></div>

    <!-- Rendered answer key chart inserted into home -->
    <div id="home-answer-key" class="answer-key"></div>
  </section>

  <!-- SELECT FACTS (Custom flow) -->
  <section id="select-facts" class="hidden">
    <h2 style="text-align:center">Select Facts</h2>
    <div class="select-facts">
      <div class="checkbox-grid" id="checkbox-grid"></div>
      <div class="select-actions">
        <button id="select-back" class="primary">Back</button>
        <button id="select-finished" class="primary">Finished</button>
      </div>
    </div>
  </section>

  <!-- SELECT TIME (after selecting facts) -->
  <section id="select-time" class="hidden">
    <h2 style="text-align:center">Select Time</h2>
    <div class="select-time">
      <label for="time-minutes">Duration (minutes) — min 0.5, max 10</label>
      <input id="time-minutes" class="time-input" type="number" step="0.5" min="0.5" max="10" value="2" />
      <div style="display:flex; gap:12px; justify-content:center; margin-top:8px">
        <button id="time-back" class="primary">Back</button>
        <button id="time-start" class="primary">Start Quiz</button>
      </div>
    </div>
  </section>

  <!-- QUIZ -->
  <section id="quiz" class="hidden">
    <div id="quiz-area">
      <div id="notice" class="notice">You have a time limit — try to complete as many questions as possible</div>

      <div class="controls">
        <button id="start-btn" class="primary">Start</button>
        <button id="finish-now">Finish Now</button>
        <div style="min-width:220px; text-align:center"><strong>Selected:</strong> <span id="selected-factor"></span></div>
      </div>

      <!-- Questions are not displayed until Start is pressed -->
      <div class="questions-grid hidden" id="questions-grid" aria-live="polite"></div>
    </div>
  </section>

  <!-- RESULTS -->
  <section id="results" class="hidden">
    <h2 style="text-align:center">Results</h2>
    <div id="summary" style="margin:12px auto; max-width:900px; text-align:center"></div>
    <div id="results-grid" class="results-grid"></div>
    <div style="margin-top:12px; text-align:center">
      <button id="back-home" class="primary">Back to Home</button>
    </div>
  </section>

  <!-- ANSWER KEY (separate full view - password protected) -->
  <section id="answer-key" class="hidden">
    <h2 style="text-align:center">Answer Key (1 × 1 through 12 × 12)</h2>
    <div class="answer-key" id="answer-key-table" style="max-width:900px; margin:12px auto"></div>
    <div style="margin-top:12px; text-align:center">
      <button id="close-answerkey">Close Answer Key</button>
    </div>
  </section>
</main>

<script>
/* ---------- Configuration ---------- */
const PASSWORD = "BOfat123";
const TOTAL_QUESTIONS = 250;

/* ---------- Utility ---------- */
function shuffle(array){
  for(let i=array.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [array[i], array[j]] = [array[j], array[i]];
  }
  return array;
}

/* ---------- State ---------- */
let selectedFactor = null;           // for single-factor quick buttons
let selectedFactorsSet = new Set();  // for Custom selection (checkboxes)
let questions = [];                  // {a,b,answer,userAnswer,timeAnswered}
let timerInterval = null;
let secondsLeft = 0;
let startTime = null;
let finished = false;
let currentMode = null; // "single" or "custom"
let selectedDurationMinutes = 2; // default

/* ---------- DOM refs ---------- */
const factorButtonsEl = document.getElementById("factor-buttons");
const homeSection = document.getElementById("home");
const selectFactsSection = document.getElementById("select-facts");
const selectTimeSection = document.getElementById("select-time");
const quizSection = document.getElementById("quiz");
const resultsSection = document.getElementById("results");
const answerKeySection = document.getElementById("answer-key");

const timerEl = document.getElementById("timer");
const selectedFactorEl = document.getElementById("selected-factor");
const questionsGrid = document.getElementById("questions-grid");
let startBtn = document.getElementById("start-btn");
const finishNowBtn = document.getElementById("finish-now");
const summaryEl = document.getElementById("summary");
const resultsGrid = document.getElementById("results-grid");
const backHomeBtn = document.getElementById("back-home");
const closeAnswerKeyBtn = document.getElementById("close-answerkey");
const answerKeyTable = document.getElementById("answer-key-table");
const homeBtn = document.getElementById("home-btn");
const noticeEl = document.getElementById("notice");
const homeAnswerKeyDiv = document.getElementById("home-answer-key");

/* select-facts refs */
const checkboxGrid = document.getElementById("checkbox-grid");
const selectBackBtn = document.getElementById("select-back");
const selectFinishedBtn = document.getElementById("select-finished");

/* select-time refs */
const timeMinutesInput = document.getElementById("time-minutes");
const timeBackBtn = document.getElementById("time-back");
const timeStartBtn = document.getElementById("time-start");

/* ---------- Initialize Home Buttons (1..12), Custom, Answer Key) ---------- */
for(let i=1;i<=12;i++){
  const btn = document.createElement("button");
  btn.className = "factor";
  btn.textContent = `${i} facts`;
  btn.title = "Click to start single-factor practice for this factor";
  // Single click starts the single-factor prepare (user will then press Start)
  btn.addEventListener("click", ()=> {
    prepareFactor(i);
  });
  factorButtonsEl.appendChild(btn);
}

/* Custom button */
const customBtn = document.createElement("button");
customBtn.className = "custom-btn";
customBtn.textContent = "Custom";
customBtn.title = "Custom Mode: Select Facts → Select Questions/Time ";
customBtn.addEventListener("click", ()=> {
  showSelectFacts();
});
factorButtonsEl.appendChild(customBtn);

/* Answer Key button (password-protected full view) */
const answerKeyBtnHome = document.createElement("button");
answerKeyBtnHome.className = "answer-key-home";
answerKeyBtnHome.textContent = "Answer Key";
answerKeyBtnHome.addEventListener("click", showAnswerKeyFromHome);
factorButtonsEl.appendChild(answerKeyBtnHome);

/* ---------- Render answer key chart into home immediately ---------- */
function renderAnswerKeyIntoHome(){
  let html = '<table style="border-collapse:collapse; margin:0 auto">';
  html += '<thead><tr><th style="padding:6px 8px; border:1px solid #ddd; background:#fafafa; font-weight:800">×</th>';
  for(let c=1;c<=12;c++) html += `<th style="padding:6px 8px; border:1px solid #ddd; background:#fafafa; font-weight:800">${c}</th>`;
  html += '</tr></thead><tbody>';
  for(let r=1;r<=12;r++){
    html += `<tr><th style="padding:6px 8px; border:1px solid #ddd; background:#fafafa; font-weight:800">${r}</th>`;
    for(let c=1;c<=12;c++){
      html += `<td style="padding:6px 8px; border:1px solid #eee">${r*c}</td>`;
    }
    html += '</tr>';
  }
  html += '</tbody></table>';
  homeAnswerKeyDiv.innerHTML = html;
}
renderAnswerKeyIntoHome();

/* ---------- Answer Key (password-protected full view) ---------- */
function showAnswerKeyFromHome(){
  if (!homeSection.classList.contains("hidden")) {
    const pass = prompt("Enter password to view the Answer Key:");
    if (pass === null) return;
    if (pass === PASSWORD) {
      renderAnswerKeyFull();
      homeSection.classList.add("hidden");
      answerKeySection.classList.remove("hidden");
      // hide answer key home button while in full view
      answerKeyBtnHome.style.display = "none";
    } else {
      alert("Incorrect password.");
    }
  }
}
function renderAnswerKeyFull(){
  let html = '<table style="border-collapse:collapse; margin:0 auto">';
  html += '<thead><tr><th style="padding:6px 8px; border:1px solid #ddd; background:#fafafa; font-weight:800">×</th>';
  for(let c=1;c<=12;c++) html += `<th style="padding:6px 8px; border:1px solid #ddd; background:#fafafa; font-weight:800">${c}</th>`;
  html += '</tr></thead><tbody>';
  for(let r=1;r<=12;r++){
    html += `<tr><th style="padding:6px 8px; border:1px solid #ddd; background:#fafafa; font-weight:800">${r}</th>`;
    for(let c=1;c<=12;c++){
      html += `<td style="padding:6px 8px; border:1px solid #eee">${r*c}</td>`;
    }
    html += '</tr>';
  }
  html += '</tbody></table>';
  answerKeyTable.innerHTML = html;
}

/* ---------- Navigation helpers ---------- */
function goHome(){
  stopTimer();
  finished = false;
  selectedFactor = null;
  questions = [];
  startTime = null;
  secondsLeft = 0;
  currentMode = null;
  selectedDurationMinutes = 2;

  homeSection.classList.remove("hidden");
  selectFactsSection.classList.add("hidden");
  selectTimeSection.classList.add("hidden");
  quizSection.classList.add("hidden");
  resultsSection.classList.add("hidden");
  answerKeySection.classList.add("hidden");

  questionsGrid.innerHTML = "";
  questionsGrid.classList.add("hidden");
  selectedFactorEl.textContent = "";
  startBtn.disabled = false;
  answerKeyBtnHome.style.display = "";
}
homeBtn.addEventListener("click", goHome);
backHomeBtn.addEventListener("click", goHome);
closeAnswerKeyBtn.addEventListener("click", ()=>{ 
  answerKeySection.classList.add("hidden");
  homeSection.classList.remove("hidden");
  answerKeyBtnHome.style.display = "";
});

/* ---------- SELECT FACTS screen logic ---------- */
function showSelectFacts(){
  // populate checkbox grid (1..12)
  checkboxGrid.innerHTML = "";
  for(let i=1;i<=12;i++){
    const item = document.createElement("label");
    item.className = "checkbox-item";
    const chk = document.createElement("input");
    chk.type = "checkbox";
    chk.value = i;
    chk.checked = selectedFactorsSet.has(i);
    chk.addEventListener("change", (ev)=>{
      if(ev.target.checked) selectedFactorsSet.add(i);
      else selectedFactorsSet.delete(i);
    });
    const span = document.createElement("span");
    span.textContent = `${i}`;
    span.style.fontWeight = "800";
    item.appendChild(chk);
    item.appendChild(span);
    checkboxGrid.appendChild(item);
  }
  homeSection.classList.add("hidden");
  selectFactsSection.classList.remove("hidden");
  selectTimeSection.classList.add("hidden");
  quizSection.classList.add("hidden");
  resultsSection.classList.add("hidden");
  answerKeySection.classList.add("hidden");
  answerKeyBtnHome.style.display = "none";
}
selectBackBtn.addEventListener("click", ()=>{
  selectFactsSection.classList.add("hidden");
  homeSection.classList.remove("hidden");
  answerKeyBtnHome.style.display = "";
});

/* When Finished pressed in Select Facts */
selectFinishedBtn.addEventListener("click", ()=>{
  if(selectedFactorsSet.size === 0){
    alert("Select at least one factor (1–12) to continue.");
    return;
  }
  selectFactsSection.classList.add("hidden");
  selectTimeSection.classList.remove("hidden");
});

/* ---------- SELECT TIME screen logic ---------- */
timeBackBtn.addEventListener("click", ()=>{
  selectTimeSection.classList.add("hidden");
  selectFactsSection.classList.remove("hidden");
});
timeStartBtn.addEventListener("click", ()=>{
  const val = Number(timeMinutesInput.value);
  if(isNaN(val) || val < 0.5 || val > 10){
    alert("Enter a valid duration between 0.5 and 10 minutes.");
    return;
  }
  selectedDurationMinutes = val;
  // prepare custom questions but do not start them yet; user still presses Start inside quiz
  prepareCustom(Array.from(selectedFactorsSet));
});

/* ---------- Prepare single-factor (quick) ---------- */
function prepareFactor(factor){
  currentMode = "single";
  selectedFactor = factor;
  selectedFactorEl.textContent = `${factor} × (1–12)`;
  const base = [];
  for(let b=1;b<=12;b++){
    base.push({a: factor, b: b, answer: factor*b});
  }
  let pool = [];
  while(pool.length < TOTAL_QUESTIONS){
    const copy = base.map(x => ({...x}));
    shuffle(copy);
    pool = pool.concat(copy);
  }
  pool.length = TOTAL_QUESTIONS;
  questions = pool.map(q => ({...q, userAnswer: "", timeAnswered: null}));
  noticeEl.classList.remove("hidden");
  homeSection.classList.add("hidden");
  selectFactsSection.classList.add("hidden");
  selectTimeSection.classList.add("hidden");
  answerKeySection.classList.add("hidden");
  resultsSection.classList.add("hidden");
  quizSection.classList.remove("hidden");
  questionsGrid.innerHTML = "";
  questionsGrid.classList.add("hidden");
  startBtn.disabled = false;
  answerKeyBtnHome.style.display = "none";
}

/* ---------- Prepare Custom (mix of selected factors) ---------- */
function prepareCustom(selectedFactorsArray){
  currentMode = "custom";
  selectedFactor = null;
  selectedFactorEl.textContent = `Custom: ${selectedFactorsArray.join(", ")}`;
  // Build random pool: choose randomly among selected factors, then pick multiplier 1..12
  const pool = [];
  for(let i=0;i<TOTAL_QUESTIONS;i++){
    const a = selectedFactorsArray[Math.floor(Math.random()*selectedFactorsArray.length)];
    const b = Math.floor(Math.random()*12)+1;
    pool.push({a, b, answer: a*b});
  }
  shuffle(pool);
  questions = pool.map(q => ({...q, userAnswer: "", timeAnswered: null}));
  // For Custom, hide the notice (no instructions)
  noticeEl.classList.add("hidden");
  homeSection.classList.add("hidden");
  selectFactsSection.classList.add("hidden");
  selectTimeSection.classList.add("hidden");
  answerKeySection.classList.add("hidden");
  resultsSection.classList.add("hidden");
  quizSection.classList.remove("hidden");
  questionsGrid.innerHTML = "";
  questionsGrid.classList.add("hidden");
  startBtn.disabled = false;
  answerKeyBtnHome.style.display = "none";
}

/* ---------- Render questions (only after Start pressed) ---------- */
function renderQuiz(){
  questionsGrid.innerHTML = "";
  for(let i=0;i<questions.length;i++){
    const q = questions[i];
    const card = document.createElement("div");
    card.className = "question-card";
    const label = document.createElement("div");
    label.className = "q-label";
    label.textContent = `${q.a} × ${q.b} =`;
    card.appendChild(label);
    const input = document.createElement("input");
    input.type = "number";
    input.inputMode = "numeric";
    input.placeholder = "";
    input.value = q.userAnswer !== undefined ? q.userAnswer : "";
    input.dataset.index = i;
    input.addEventListener("keydown", (ev)=>{
      if(ev.key === "Enter"){
        ev.preventDefault();
        recordAnswerFromInput(i);
      }
    });
    input.addEventListener("input", (ev)=>{
      questions[i].userAnswer = ev.target.value;
    });
    const enterBtn = document.createElement("button");
    enterBtn.className = "enter-btn";
    enterBtn.textContent = "Enter";
    enterBtn.addEventListener("click", ()=> recordAnswerFromInput(i));
    card.appendChild(input);
    card.appendChild(enterBtn);
    questionsGrid.appendChild(card);
  }
  questionsGrid.classList.remove("hidden");
  const firstInput = questionsGrid.querySelector('input[data-index="0"]');
  if(firstInput) firstInput.focus();
}

/* ---------- Start / Timer / Finish ---------- */
startBtn.addEventListener("click", ()=>{
  if(!questions || questions.length === 0) return alert("No quiz prepared. Return home and choose a factor or custom.");
  startBtn.disabled = false;
  // duration depends: if custom flow, use selectedDurationMinutes; if single, default 2 min (or keep 2)
  const durationSec = Math.round((selectedDurationMinutes || 2) * 60);
  secondsLeft = durationSec;
  timerEl.classList.remove("hidden");
  updateTimerDisplay();
  startTime = Date.now();
  finished = false;
  renderQuiz();
  timerInterval = setInterval(()=>{
    secondsLeft = Math.max(0, durationSec - Math.floor((Date.now() - startTime)/1000));
    updateTimerDisplay();
    if(secondsLeft <= 0){
      stopTimer();
      finishQuiz();
    }
  }, 200);
});

finishNowBtn.addEventListener("click", ()=>{
  if(confirm("Finish now and view results?")){
    stopTimer();
    finishQuiz();
  }
});

function stopTimer(){
  if(timerInterval){
    clearInterval(timerInterval);
    timerInterval = null;
  }
  timerEl.classList.add("hidden");
}

function updateTimerDisplay(){
  const mm = String(Math.floor(secondsLeft / 60)).padStart(2,"0");
  const ss = String(secondsLeft % 60).padStart(2,"0");
  timerEl.textContent = `${mm}:${ss}`;
}

/* ---------- Record answers ---------- */
function recordAnswerFromInput(index){
  const input = questionsGrid.querySelector(`input[data-index="${index}"]`);
  if(!input) return;
  const raw = input.value;
  if(startTime && !questions[index].timeAnswered){
    questions[index].timeAnswered = (Date.now() - startTime) / 1000;
  }
  questions[index].userAnswer = raw === "" ? "" : raw;
  const nextIndex = index + 1;
  if(nextIndex < questions.length){
    const nextInput = questionsGrid.querySelector(`input[data-index="${nextIndex}"]`);
    if(nextInput) nextInput.focus();
  }
}

/* ---------- Finish & Results ---------- */
function finishQuiz(){
  if(finished) return;
  finished = true;
  stopTimer();
  const now = Date.now();
  const elapsedSeconds = Math.round((now - (startTime || now))/1000);
  // Completed = answered (non-empty)
  const completedQuestions = questions.filter(q => q.userAnswer !== "" && q.userAnswer !== undefined);
  const completed = completedQuestions.length;
  let correctCount = 0;
  resultsGrid.innerHTML = "";
  for(let i=0;i<questions.length;i++){
    const q = questions[i];
    if(q.userAnswer !== "" && q.userAnswer !== undefined){
      const uaNum = Number(q.userAnswer);
      const correct = (uaNum === q.answer);
      if(correct) correctCount++;
      const card = document.createElement("div");
      card.className = "result-card " + (correct ? "correct" : "incorrect");
      const top = document.createElement("div");
      top.textContent = `${q.a} × ${q.b} =`;
      top.style.fontWeight = "700";
      top.style.fontSize = "16px";
      const inputBox = document.createElement("div");
      inputBox.style.padding = "8px";
      inputBox.style.borderRadius = "6px";
      inputBox.style.background = "#f3f3f3";
      inputBox.style.fontWeight = "700";
      inputBox.textContent = String(q.userAnswer);
      const correctLine = document.createElement("div");
      correctLine.className = "small-muted";
      correctLine.textContent = `Correct Answer: ${q.answer}`;
      card.appendChild(top);
      card.appendChild(inputBox);
      card.appendChild(correctLine);
      resultsGrid.appendChild(card);
    }
  }
  const avgTimePerQuestion = completed > 0 ? (elapsedSeconds / completed) : 0;
  const questionsPerMinute = avgTimePerQuestion > 0 ? (60 / avgTimePerQuestion) : 0;
  const percentage = completed > 0 ? (correctCount / completed * 100) : 0;

  summaryEl.innerHTML = `
    <div><strong>Score:</strong> ${correctCount} / ${completed}</div>
    <div><strong>Percentage:</strong> ${percentage.toFixed(1)}%</div>
    <div><strong>Total elapsed:</strong> ${elapsedSeconds} seconds</div>
    <div><strong>Average time per answered question:</strong> ${avgTimePerQuestion.toFixed(2)} s</div>
    <div><strong>Questions per minute (from average):</strong> ${questionsPerMinute.toFixed(2)}</div>
  `;

  quizSection.classList.add("hidden");
  resultsSection.classList.remove("hidden");
}

/* ---------- Initial state ---------- */
goHome();
</script>

<!-- =========================
     Appended script — do not modify base code above;
     enhancements added below.
     ========================= -->
<script>
/*
  Enhancements added on top of your base:
  - In Select Time screen add a Time / Questions toggle when Custom flow used.
  - Questions mode: allow 2–500 questions; hide the time notice; prepare the requested questions.
  - Show a Finish button (next to Finish Now) once the last question is answered.
  - Update results summary to include Questions Total and use the exact requested lines.
*/

(function(){
  // Safety checks
  if(!document.getElementById('select-time')) return;

  // 1) Insert Time / Questions toggle and questions input into existing Select Time area
  const selectTimeDiv = document.querySelector('#select-time .select-time');
  const modeDiv = document.createElement('div');
  modeDiv.style.textAlign = 'center';
  modeDiv.style.marginBottom = '10px';
  modeDiv.innerHTML = `
    <label style="font-weight:700; margin-right:12px;"><input type="radio" name="custom-mode" value="time" checked> Time</label>
    <label style="font-weight:700;"><input type="radio" name="custom-mode" value="questions"> Questions</label>
  `;
  // Insert at top of select-time block
  selectTimeDiv.insertBefore(modeDiv, selectTimeDiv.firstChild);

  // Questions controls (hidden by default)
  const qControls = document.createElement('div');
  qControls.id = 'custom-questions-controls';
  qControls.className = 'hidden';
  qControls.style.marginTop = '8px';
  qControls.innerHTML = `
    <label for="custom-question-count">Number of questions — min 2, max 500</label><br/>
    <input id="custom-question-count" type="number" min="2" max="500" step="1" value="250" class="time-input" style="margin-top:6px; width:120px"/>
  `;
  // insert qControls before the bottom button row
  const buttonsRow = selectTimeDiv.querySelector('div[style*="justify-content:center"]');
  selectTimeDiv.insertBefore(qControls, buttonsRow);

  // Show/hide logic for toggle
  const radioTime = selectTimeDiv.querySelector('input[type="radio"][value="time"]');
  const radioQuestions = selectTimeDiv.querySelector('input[type="radio"][value="questions"]');
  const timeInput = document.getElementById('time-minutes');

  function updateSelectTimeUI(){
    if(radioQuestions.checked){
      qControls.classList.remove('hidden');
      timeInput.classList.add('hidden');
      // hide the notice on start preparation (we will also hide when quiz prepared)
      if(document.getElementById('notice')) document.getElementById('notice').classList.add('hidden');
    } else {
      qControls.classList.add('hidden');
      timeInput.classList.remove('hidden');
      if(document.getElementById('notice')) document.getElementById('notice').classList.remove('hidden');
    }
  }
  radioTime.addEventListener('change', updateSelectTimeUI);
  radioQuestions.addEventListener('change', updateSelectTimeUI);

  // 2) Replace the existing time-start button to remove base listener and attach custom handler
  const oldStartBtn = document.getElementById('time-start');
  const newStartBtn = oldStartBtn.cloneNode(true);
  oldStartBtn.parentNode.replaceChild(newStartBtn, oldStartBtn);
  // Make sure we have fresh reference
  const customStartBtn = document.getElementById('time-start');

  customStartBtn.addEventListener('click', function(){
    // If radio Questions selected => prepare questions mode; else use existing time behavior (call prepareCustom)
    if(radioQuestions.checked){
      const qcInput = document.getElementById('custom-question-count');
      const qc = Number(qcInput.value);
      if(isNaN(qc) || qc < 2 || qc > 500){
        alert('Enter a valid number of questions between 2 and 500.');
        return;
      }
      // Build base pool of TOTAL_QUESTIONS (250) using currently selected factors
      const chosen = Array.from(selectedFactorsSet);
      if(chosen.length === 0){
        alert('Select at least one factor first.');
        return;
      }
      const base = [];
      while(base.length < TOTAL_QUESTIONS){
        const a = chosen[Math.floor(Math.random()*chosen.length)];
        const b = Math.floor(Math.random()*12)+1;
        base.push({a,b,answer:a*b});
      }
      shuffle(base);
      // Build final pool according to qc
      let final = [];
      if(qc <= TOTAL_QUESTIONS){
        final = base.slice(0, qc).map(q=>({...q}));
      } else {
        // qc > 250: use base 250 then append first (qc-250) WITHOUT reshuffle (same order)
        final = base.map(q=>({...q}));
        const extra = base.slice(0, qc - TOTAL_QUESTIONS).map(q=>({...q}));
        final = final.concat(extra);
      }
      // Set global questions to final
      questions = final.map(q=>({...q, userAnswer:'', timeAnswered:null}));
      // Hide the notice per request
      if(document.getElementById('notice')) document.getElementById('notice').classList.add('hidden');
      // Show quiz view (like prepareCustom normally does)
      selectedFactorEl.textContent = `Custom: ${chosen.join(', ')}`;
      homeSection.classList.add('hidden');
      selectFactsSection.classList.add('hidden');
      selectTimeSection.classList.add('hidden');
      answerKeySection.classList.add('hidden');
      resultsSection.classList.add('hidden');
      quizSection.classList.remove('hidden');
      questionsGrid.innerHTML = '';
      questionsGrid.classList.add('hidden');
      startBtn.disabled = false;
      // Hide answer key while in quiz
      if(typeof answerKeyBtnHome !== 'undefined' && answerKeyBtnHome) answerKeyBtnHome.style.display = 'none';
      // ensure the Start flow uses selectedDurationMinutes only if Time is used; for question mode timer won't be started (unless user still presses Start and we want no timer)
      // We'll set a flag on window to indicate questions-mode for Start to avoid timer behavior: set window._customMode='questions' or 'time'
      window._customMode = 'questions';
      window._customQuestionCount = qc;
      return;
    } else {
      // Time mode — preserve original behavior
      const val = Number(timeMinutesInput.value);
      if(isNaN(val) || val < 0.5 || val > 10){
        alert("Enter a valid duration between 0.5 and 10 minutes.");
        return;
      }
      selectedDurationMinutes = val;
      // call the original prepareCustom that base provided
      if(typeof prepareCustom === 'function'){
        prepareCustom(Array.from(selectedFactorsSet));
        // mark custom mode flag
        window._customMode = 'time';
      } else {
        alert('Internal error: prepareCustom unavailable.');
      }
    }
  });

  // 3) Before user clicks Start on quiz, we need Start behavior to respect questions-mode (no timer).
  // Replace existing Start click behavior by wrapping: clone and replace Start button to remove base's listener to ensure we handle modes.
  const oldStartMainBtn = document.getElementById('start-btn');
  const newStartMainBtn = oldStartMainBtn.cloneNode(true);
  oldStartMainBtn.parentNode.replaceChild(newStartMainBtn, oldStartMainBtn);
startBtn = newStartMainBtn;


  newStartMainBtn.addEventListener('click', function(){
    if(!questions || !Array.isArray(questions) || questions.length === 0){
      alert("No quiz prepared. Return home and choose a factor or custom.");
      return;
    }
    // If custom questions mode selected, run renderQuiz WITHOUT starting timer.
    if(window._customMode === 'questions'){
      // simply render questions and do NOT start the timer
      newStartMainBtn.disabled = true;
      // Hide timer display to be safe
      if(timerEl) timerEl.classList.add('hidden');
      startTime = Date.now();
      finished = false;
      renderQuiz(); // base function to render inputs
      // ensure no interval running
      if(timerInterval){ clearInterval(timerInterval); timerInterval = null; }
      // Since we didn't start a timer, nothing else needed.
      return;
    }
    // Else default: time mode or single-factor — mimic original behavior using base variables
    // compute duration from selectedDurationMinutes (base code assumes that variable)
    newStartMainBtn.disabled = true;
    const durationSec = Math.round((selectedDurationMinutes || 2) * 60);
    secondsLeft = durationSec;
    if(timerEl) timerEl.classList.remove('hidden');
    updateTimerDisplay();
    startTime = Date.now();
    finished = false;
    renderQuiz();
    if(timerInterval){ clearInterval(timerInterval); timerInterval = null; }
    timerInterval = setInterval(()=>{
      secondsLeft = Math.max(0, durationSec - Math.floor((Date.now() - startTime)/1000));
      updateTimerDisplay();
      if(secondsLeft <= 0){
        if(timerInterval){ clearInterval(timerInterval); timerInterval = null; }
        if(timerEl) timerEl.classList.add('hidden');
        if(typeof finishQuiz === 'function') finishQuiz();
      }
    }, 200);
  });

  // 4) Add a Finish button next to the existing Finish Now button; hidden until last question answered.
  const finishNowBtn = document.getElementById('finish-now');
  const finishBtn = document.createElement('button');
  finishBtn.id = 'finish-last-btn';
  finishBtn.textContent = 'Finish';
  finishBtn.className = 'primary';
  finishBtn.style.display = 'none';
  finishNowBtn.parentNode.insertBefore(finishBtn, finishNowBtn.nextSibling);
  finishBtn.addEventListener('click', function(){ if(typeof finishQuiz === 'function') finishQuiz(); });

  // 5) Attach a MutationObserver to the questionsGrid to attach input listeners when renderQuiz populates it.
  const qGrid = document.getElementById('questions-grid');
  const mo = new MutationObserver((mutations)=>{
    for(const m of mutations){
      if(m.addedNodes && m.addedNodes.length){
        // add listeners to inputs to watch for last question answered
        const inputs = qGrid.querySelectorAll('input[type="number"]');
        inputs.forEach(input =>{
          if(!input.dataset._listenerAttached){
            input.dataset._listenerAttached = '1';
            input.addEventListener('input', function(){
              // update the global questions array is already handled by base; we just check last index
              const lastIndex = questions.length - 1;
              if(lastIndex >= 0 && questions[lastIndex] && questions[lastIndex].userAnswer !== "" && questions[lastIndex].userAnswer !== undefined){
                finishBtn.style.display = 'inline-block';
              } else {
                // hide if undone
                // don't hide if user intentionally wants to finish otherwise; but spec wants to show after last answered
                finishBtn.style.display = 'none';
              }
            });
          }
        });
      }
    }
  });
  mo.observe(qGrid, { childList:true, subtree:true });

  // 6) Update results summary to include Questions Total and use specified lines.
  // We'll observe results section class changes and update summary when it becomes visible.
  const resultsSection = document.getElementById('results');
  const mo2 = new MutationObserver((mutations)=>{
    for(const m of mutations){
      if(m.attributeName === 'class'){
        if(!resultsSection.classList.contains('hidden')){
          // compute numbers from global questions array
          const completedArr = questions.filter(q=> q.userAnswer !== "" && q.userAnswer !== undefined);
          const completed = completedArr.length;
          const correct = completedArr.reduce((acc,q)=> acc + ((Number(q.userAnswer) === q.answer) ? 1 : 0), 0);
          const totalQuestions = Array.isArray(questions) ? questions.length : 0;
          const elapsed = startTime ? Math.round((Date.now() - startTime)/1000) : 0;
          const avg = completed>0 ? (elapsed / completed) : 0;
          const qpm = avg>0 ? (60 / avg) : 0;
          const pct = completed>0 ? ((correct / completed) * 100).toFixed(1) : '0.0';
          // Overwrite summary exactly in requested format and include Questions Total field
          summaryEl.innerHTML = `
            <div><strong>Questions Total:</strong> ${totalQuestions}</div>
            <div><strong>Score:</strong> ${correct} / ${completed}</div>
            <div><strong>Percentage:</strong> ${pct}%</div>
            <div><strong>Total elapsed:</strong> ${elapsed} seconds</div>
            <div><strong>Average time per answered question:</strong> ${avg.toFixed(2)} s</div>
            <div><strong>Questions per minute (from average):</strong> ${qpm.toFixed(2)}</div>
          `;
        }
      }
    }
  });
  mo2.observe(resultsSection, { attributes:true });

  // 7) Ensure when switching back to home we clear custom mode flag
  const homeBtn = document.getElementById('home-btn');
  homeBtn.addEventListener('click', ()=>{ window._customMode = undefined; });

  // 8) When user goes back from select-facts keep the radios consistent
  updateSelectTimeUI(); // initial sync in case UI needs it

})();
</script>
</body>
</html>
